#!/bin/sh
set -e

# 1) Wait for DB
while ! nc -z mariadb 3306; do
  echo "WordPress: Waiting for MariaDB..."
  sleep 1
done

# 2) Ensure www-data user/group matches PHP-FPM
addgroup -S www-data
adduser -D -S -G www-data www-data
chown -R www-data:www-data /var/www/html

# 3) Patch PHP-FPM to listen on all interfaces
sed -i 's/^listen = .*$/listen = 0.0.0.0:9000/' /etc/php83/php-fpm.d/www.conf
sed -i 's/^user = .*$/user = www-data/' /etc/php83/php-fpm.d/www.conf
sed -i 's/^group = .*$/group = www-data/' /etc/php83/php-fpm.d/www.conf

# 4) One‚Äêshot WP install & config
if [ ! -f /var/www/html/wp-config.php ]; then
  echo "WordPress: Installing core..."
  cd /var/www/html

  curl -L https://wordpress.org/wordpress-6.8.tar.gz \
    | tar --strip-components=1 -xz

  echo "WordPress: Downloading WP-CLI..."
  curl -sSL https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
    -o /usr/local/bin/wp \
    && chmod +x /usr/local/bin/wp

  WP="php -d memory_limit=256M /usr/local/bin/wp --allow-root"

  echo "WordPress: Creating wp-config.php..."
  $WP config create \
    --dbname="$WORDPRESS_DB_NAME" \
    --dbuser="$WORDPRESS_DB_USER" \
    --dbpass="$WORDPRESS_DB_PASSWORD" \
    --dbhost="$WORDPRESS_DB_HOST"

  echo "WordPress: Installing site..."
  $WP core install \
    --url="$DOMAIN_NAME" \
    --title="$WORDPRESS_TITLE" \
    --admin_user="$WORDPRESS_ADMIN_USER" \
    --admin_password="$WORDPRESS_ADMIN_PASSWORD" \
    --admin_email="$WORDPRESS_ADMIN_EMAIL" \
    --skip-email

  echo "WordPress: Creating secondary user..."
  $WP user create \
    "$WORDPRESS_SECONDARY_USER" "$WORDPRESS_USER_EMAIL" \
    --role=author \
    --user_pass="$WORDPRESS_DB_PASSWORD"
fi

echo "WordPress: Launching PHP-FPM."
exec php-fpm83 -F

